<template id='issue-list-template'>
<div class='container'>
	<tool-navbar>
		<!--<div slot='right'>
			<a href='https://github.com/magnusmanske/picturesque' target='_blank' title='GitHub'>
				<img src='https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Github-desktop-logo-symbol.svg/38px-Github-desktop-logo-symbol.svg.png' />
			</a>
		</div>
	-->
	</tool-navbar>

	<div class='row'>
		<h2 tt='issues'></h2>
	</div>

	<div class='row mb-1'>
		<div class="btn-group btn-group-toggle mr-1" data-toggle="buttons" v-for='group in button_groups'>
			<label v-for='value in config[group]' :class='"btn btn-outline-secondary"+(filters[group][value]?" active":"")'>
				<input type="checkbox" v-model='filters[group][value]' /> {{capitalize(value)}}
  			</label>
		</div>
	</div>

	<div class='row'>
		<div tt='sort_by' class='mr-1'>
		</div>
		<div>
			<select v-model='filters.sort_by' class="custom-select">
				<option v-for='o in sort_by_options' :tt='o' :value='o'></option>
			</select>
		</div>
		<div>
			<div class="btn-group btn-group-toggle" data-toggle="buttons">
				<label v-for='order in sort_orders' :class='"btn btn-outline-secondary"+(filters.sort_order==order?" active":"")'>
					<input type="radio" v-model='filters.sort_order' :value='order' /> <span :tt='order'></span>
				</label>
			</div>
		</div>
		<div class='ml-4'>
			<button class='btn btn-outline-primary' @click.prevent='load_results' tt='update'></button>
		</div>
	</div>

	<div class='row' v-if='loading'>
		<i tt='loading'></i>
	</div>
	<div class='row' v-else-if='results.len==0'>
		<i tt='no_results'></i>
	</div>
	<div class='row mt-1 mb-1' v-else>
		<div class='row'>
			<div class='mr-2'>
				<span tt='this_query'></span>
				{{stats.this_query}}
			</div>
			<div class='mr-2'>
				<span tt='total_open'></span>
				{{stats.total_open}}
			</div>
			<div class='ml-4'>
				<span v-if='filters.offset>0' class='mr-1'>
					<a href='#' @click.prevent='go_to_offset(filters.offset-filters.limit)' tt='prev'></a>
				</span>
				<span class='mr-1'>
					<input style='width: 6rem;' type='number' v-model='filters.offset' @keyup.enter='go_to_offset(filters.offset)' />
				</span>
				<span v-if='filters.offset+filters.limit<stats.this_query'>
					<a href='#' @click.prevent='go_to_offset(filters.offset+filters.limit)' tt='next'></a>
				</span>
			</div>
		</div>
		<table class='table table-striped'>
			<tr v-for='r in results'>
				<td>
					<a :href='r.url' target='_blank'>
						<img v-if='typeof image_url[r.site]!="undefined"' border=0 :title='r.site' :src='image_url[r.site]'/>
						<span v-else>{{r.site}}</span>
					</a>
				</td>
				<td>
					{{r.label}}
				</td>
				<td>
					{{r.status}}<br/>
					{{r.priority}}
				</td>
				<td nowrap>
					{{r.date_created}}<br/>
					{{r.date_last}}
				</td>
				<td>
					<pre style='font-size: 6pt; max-width: 300pt;'>
						{{r.description}}
					</pre>
				</td>
				<td>
					<span v-if='r.tool==0'>
						???
					</span>
					<span v-else>
						TOOL {{r.tool}}
					</span>
				</td>
			</tr>
		</table>
	</div>

</div>
</template>

<script>
'use strict';

let IssueList = Vue.extend ( {
	props : [] ,
	data : function () { return { filters : { label:'' , status:{} , sort_by:'date_last' , sort_order:'descending' , site:{} , description:'' , tool:'' , priority:{} , limit:25 , offset:0 } ,
		results:[] , loading:false , stats:{} ,
		sort_by_options:['label','status','date_created','date_last','site','tool','priority'] ,
		button_groups:['site','status','priority'] ,
		sort_orders:['ascending','descending'] ,
		image_url:{
			'WIKI':'https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Wikipedia-logo-v2.svg/64px-Wikipedia-logo-v2.svg.png',
			'WIKIDATA':'https://upload.wikimedia.org/wikipedia/commons/thumb/f/ff/Wikidata-logo.svg/64px-Wikidata-logo.svg.png',
			'GITHUB':'https://upload.wikimedia.org/wikipedia/commons/thumb/c/c6/Font_Awesome_5_brands_github-square.svg/64px-Font_Awesome_5_brands_github-square.svg.png',
			'BITBUCKET':'https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Bitbucket-blue-logomark-only.svg/64px-Bitbucket-blue-logomark-only.svg.png'
		}
	} } ,
	created : function () {
		let me = this ;
		$.each ( me.button_groups , function ( dummy0 , key ) {
			$.each ( config[key] , function(dummy,value){Vue.set(me.filters[key],value,false)})
		} ) ;
		me.filters.status.OPEN = true ;
		me.load_results();
		tt.updateInterface(this.$el) ;
	} ,
	mounted : function () {
		tt.updateInterface(this.$el) ;
	} ,
    updated : function () { tt.updateInterface(this.$el) ; } ,
	methods : {
		load_results : function () {
			let me = this ;
			me.loading = true ;
			me.results = [] ;
			let params = JSON.parse ( JSON.stringify(me.filters) ) ;
			$.each ( me.button_groups , function ( dummy , group ) {
				params[group] = me.collapse_options(params[group]);
			} ) ;
			params.action = 'get_issues' ;
			//console.log(params);
			$.get('./api.php',params,function(d){
				//console.log(d) ;
				if ( d.status == 'OK' ) {
					me.results = d.data.results ;
					me.stats = d.data.stats ;
				} else {
					alert ( d.status ) ;
				}
				me.loading = false ;
			} ) ;
		} ,
		collapse_options : function ( o ) {
			let ret = [] ;
			$.each ( o , function ( k , v ) {
				if ( v ) ret.push(k);
			} ) ;
			return ret.join(',');
		} ,
		go_to_offset : function ( new_offset ) {
			this.filters.offset = new_offset*1 ;
			this.load_results();
		} ,
		capitalize : function (s) {
			if (typeof s !== 'string') return ''
			return s.charAt(0).toUpperCase() + s.slice(1).toLowerCase()
		} ,
	} ,
	template : '#issue-list-template'
} ) ;

</script>
